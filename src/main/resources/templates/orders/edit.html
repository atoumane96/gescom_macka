<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::title}, ~{::content}, ~{::js_assets})}">
<head>
    <title>Modifier la Commande</title>
</head>
<body>
<div th:fragment="content">
    <div class="container-fluid">
        <!-- En-tête -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="h3">
                    <i class="fas fa-edit me-2"></i>
                    Modifier la Commande <span th:text="${order.orderNumber}">N/A</span>
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a th:href="@{/dashboard}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a th:href="@{/orders}">Commandes</a></li>
                        <li class="breadcrumb-item"><a th:href="@{/orders/{id}(id=${order.id})}">Détails</a></li>
                        <li class="breadcrumb-item active">Modifier</li>
                    </ol>
                </nav>
            </div>
            <div class="col-md-4 text-end">
                <a th:href="@{/orders/{id}(id=${order.id})}" class="btn btn-secondary me-2">
                    <i class="fas fa-arrow-left me-1"></i>Retour
                </a>
                <button type="submit" form="orderForm" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Enregistrer
                </button>
            </div>
        </div>

        <form th:action="@{/orders/{id}/update(id=${order.id})}" method="post" id="orderForm" 
              onsubmit="return validateOrderForm()">
            <div class="row">
                <!-- Colonne principale -->
                <div class="col-lg-8">
                    <!-- Informations générales -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations Générales</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="orderNumber" class="form-label">Numéro de Commande</label>
                                        <input type="text" class="form-control" id="orderNumber" 
                                               th:value="${order.orderNumber}" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="orderDate" class="form-label">Date de Commande</label>
                                        <input type="text" class="form-control" id="orderDate" 
                                               th:value="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="client" class="form-label">Client *</label>
                                        <select class="form-select" id="client" name="client.id" required>
                                            <option value="">Sélectionner un client</option>
                                            <option th:each="client : ${clients}" 
                                                    th:value="${client.id}"
                                                    th:text="${client.name + (client.companyName != null ? ' (' + client.companyName + ')' : '')}"
                                                    th:selected="${client.id == order.client.id}">
                                                Client
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="status" class="form-label">Statut</label>
                                        <select class="form-select" id="status" name="status">
                                            <option th:value="${order.status}" 
                                                    th:text="${order.status}" 
                                                    selected>Statut actuel</option>
                                            <option th:each="status : ${possibleStatuses}" 
                                                    th:value="${status}"
                                                    th:text="${status}">
                                                Statut
                                            </option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Articles de la commande -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-box me-2 text-success"></i>Produits de la commande</h5>
                            <button type="button" class="btn btn-success" onclick="window.addProduct()">
                                <i class="fas fa-plus me-2"></i>Ajouter un produit
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table" id="orderItemsTable">
                                    <thead>
                                    <tr>
                                        <th style="width: 40%;">Produit</th>
                                        <th style="width: 10%;">Qté</th>
                                        <th style="width: 15%;">Prix unitaire</th>
                                        <th style="width: 10%;">Remise %</th>
                                        <th style="width: 15%;">Total HT</th>
                                        <th style="width: 10%;">Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody id="orderItemsBody">
                                    <!-- Les lignes seront ajoutées dynamiquement -->
                                    <tr id="emptyRow">
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="fas fa-shopping-basket fa-2x mb-2"></i><br>
                                            Aucun produit ajouté.<br>
                                            <small>Cliquez sur "Ajouter un produit" pour commencer.</small>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Colonne latérale -->
                <div class="col-lg-4">
                    <!-- Totaux -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Totaux</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Total HT:</span>
                                <span id="totalHT" th:text="${#numbers.formatCurrency(order.totalAmountHT ?: 0)}">0,00 €</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>TVA:</span>
                                <span id="totalVAT" th:text="${#numbers.formatCurrency(order.totalVatAmount ?: 0)}">0,00 €</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <span class="h5"><strong>Total TTC:</strong></span>
                                <span id="totalTTC" class="h5 text-primary" 
                                      th:text="${#numbers.formatCurrency(order.totalAmount ?: 0)}">0,00 €</span>
                            </div>
                        </div>
                    </div>

                    <!-- Actions rapides -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Actions Rapides</h5>
                        </div>
                        <div class="card-body">
                            <!-- Bouton Facturation -->
                            <div th:if="${canInvoice}" class="d-grid mb-3">
                                <a th:href="@{/invoices/new(orderId=${order.id})}" class="btn btn-success mb-2">
                                    <i class="fas fa-file-invoice-dollar me-2"></i>
                                    Créer une facture
                                </a>
                                <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#invoicePreviewModal" onclick="generateInvoicePreview()">
                                    <i class="fas fa-eye me-2"></i>
                                    Prévisualiser facture
                                </button>
                            </div>
                            
                            <!-- Facture existante -->
                            <div th:if="${order.invoice != null}" class="d-grid mb-3">
                                <a th:href="@{/invoices/{id}(id=${order.invoice.id})}" class="btn btn-outline-primary">
                                    <i class="fas fa-file-invoice me-2"></i>
                                    Voir la facture
                                </a>
                            </div>

                            <!-- Message d'info -->
                            <div th:if="${!canInvoice and order.invoice == null}" class="alert alert-info">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span th:if="${!(order.status.name() == 'CONFIRMED' or order.status.name() == 'PROCESSING' or order.status.name() == 'SHIPPED' or order.status.name() == 'DELIVERED')}">
                                        La facturation sera disponible quand la commande sera confirmée.
                                    </span>
                                    <span th:if="${(order.status.name() == 'CONFIRMED' or order.status.name() == 'PROCESSING' or order.status.name() == 'SHIPPED' or order.status.name() == 'DELIVERED') and order.invoice != null}">
                                        Cette commande a déjà été facturée.
                                    </span>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Statut actuel -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info me-2"></i>Statut</h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center">
                                <span th:switch="${order.status.name()}" class="badge rounded-pill fs-6">
                                    <span th:case="'DRAFT'" class="bg-secondary">Brouillon</span>
                                    <span th:case="'PENDING'" class="bg-warning text-dark">En attente</span>
                                    <span th:case="'CONFIRMED'" class="bg-primary">Confirmée</span>
                                    <span th:case="'PROCESSING'" class="bg-info">En traitement</span>
                                    <span th:case="'SHIPPED'" class="bg-warning text-dark">Expédiée</span>
                                    <span th:case="'DELIVERED'" class="bg-success">Livrée</span>
                                    <span th:case="'RETURNED'" class="bg-danger">Retournée</span>
                                    <span th:case="'CANCELLED'" class="bg-dark">Annulée</span>
                                </span>
                            </div>
                            <small class="text-muted d-block text-center mt-2">
                                Dernière modification: <span th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}">N/A</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        
        <!-- Input hidden pour les order items - DOIT ÊTRE DANS LE FORMULAIRE -->
        <div id="orderItemsInputs"></div>
        
        <!-- Modal de sélection des produits (identique à form.html) -->
        <div id="productModal" class="custom-modal" style="display: none;" onclick="window.closeProductModal()">
            <div class="custom-modal-dialog" onclick="event.stopPropagation()">
                <!-- Card principale contenant tous les éléments -->
                <div class="card shadow-lg border-0" style="border-radius: 15px; overflow: hidden;">
                    <!-- Header de la card -->
                    <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-white bg-opacity-25 rounded-circle p-2">
                                        <i class="fas fa-shopping-basket text-white"></i>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="mb-0 text-white">Catalogue des Produits</h5>
                                    <small class="text-white-50">Sélectionnez les produits à ajouter à votre commande</small>
                                </div>
                            </div>
                            <button type="button" class="btn btn-link text-white p-2" onclick="window.closeProductModal()"
                                    style="text-decoration: none; border-radius: 50%; width: 40px; height: 40px;"
                                    title="Fermer">
                                <i class="fas fa-times fs-5"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Corps de la card avec les filtres -->
                    <div class="card-body p-0">
                        <!-- Section filtres -->
                        <div class="bg-light border-bottom" style="position: sticky; top: 0; z-index: 10;">
                            <div class="p-4">
                                <div class="row g-3">
                                    <!-- Recherche principale -->
                                    <div class="col-lg-4">
                                        <label class="form-label fw-semibold text-primary">
                                            <i class="fas fa-search me-2"></i>Recherche
                                        </label>
                                        <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0">
                                        <i class="fas fa-search text-muted"></i>
                                    </span>
                                            <input type="text" class="form-control border-start-0" id="productSearch"
                                                   placeholder="Nom, référence du produit..." style="box-shadow: none;">
                                            <button class="btn btn-outline-secondary border-start-0" type="button" onclick="clearSearch()">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Filtre catégorie -->
                                    <div class="col-lg-2">
                                        <label class="form-label fw-semibold text-primary">
                                            <i class="fas fa-tags me-2"></i>Catégorie
                                        </label>
                                        <select class="form-select" id="categoryFilter">
                                            <option value="">Toutes</option>
                                            <option th:each="category : ${categories}" th:value="${category}" th:text="${category}">Catégorie</option>
                                        </select>
                                    </div>

                                    <!-- Boutons actions -->
                                    <div class="col-lg-2">
                                        <label class="form-label fw-semibold">&nbsp;</label>
                                        <div class="d-grid">
                                            <button class="btn btn-warning" onclick="resetAllFilters()">
                                                <i class="fas fa-undo me-1"></i>Reset
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section catalogue des produits -->
                        <div class="p-4" style="min-height: 400px; max-height: 500px; overflow-y: auto;">
                            <!-- Vue tableau -->
                            <div id="tableView" class="product-view">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light sticky-top">
                                        <tr>
                                            <th class="border-0">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-box text-primary me-2"></i>
                                                    <span>Produit</span>
                                                </div>
                                            </th>
                                            <th class="border-0 text-end">
                                                <div class="d-flex align-items-center justify-content-end">
                                                    <i class="fas fa-euro-sign text-success me-2"></i>
                                                    <span>Prix HT</span>
                                                </div>
                                            </th>
                                            <th class="border-0 text-center">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-warehouse text-info me-2"></i>
                                                    <span>Stock</span>
                                                </div>
                                            </th>
                                            <th class="border-0 text-center">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-plus text-warning me-2"></i>
                                                    <span>Action</span>
                                                </div>
                                            </th>
                                        </tr>
                                        </thead>
                                        <tbody id="productList">
                                        <!-- Produits chargés dynamiquement -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer de la card -->
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-lightbulb text-warning me-2"></i>
                                    <small class="text-muted">Cliquez sur "Ajouter" pour sélectionner un produit</small>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-secondary" onclick="window.closeProductModal()">
                                    <i class="fas fa-times me-2"></i>Fermer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de prévisualisation de facture -->
    <div class="modal fade" id="invoicePreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-eye me-2"></i>
                        Prévisualisation de la Facture
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="invoicePreviewContent">
                        <!-- Le contenu sera chargé ici par JavaScript -->
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <a th:href="@{/invoices/new(orderId=${order.id})}" class="btn btn-success">
                        <i class="fas fa-file-invoice-dollar me-2"></i>
                        Créer la facture
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:fragment="js_assets">
    <!-- CSS pour la modal (identique à form.html) -->
    <style>
        /* Styles pour la modal avec card modernisée */
        .custom-modal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 99999 !important;
            display: none;
            align-items: center !important;
            justify-content: center !important;
            background: rgba(0, 0, 0, 0.8) !important;
            backdrop-filter: blur(3px);
        }

        .custom-modal-dialog {
            max-width: 1200px;
            width: 95%;
            max-height: 90vh;
            margin: auto;
            animation: modalFadeIn 0.3s ease-out;
        }

        .custom-modal .card {
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .custom-modal .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Table responsive avec scroll smooth */
        .table-responsive {
            scrollbar-width: thin;
            scrollbar-color: #6c757d #f8f9fa;
        }

        .table-responsive::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 4px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: #6c757d;
            border-radius: 4px;
        }

        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #495057;
        }

        /* États de la table */
        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.05);
            transform: scale(1.001);
        }
    </style>
    
    <script th:inline="javascript">
        // Variables globales pour la page edit
        let orderItems = [];
        let itemCounter = 0;
        let allProducts = [];

        // Chargement des articles existants depuis Thymeleaf
        /*[# th:each="item, itemStat : ${order.orderItems}"]*/
        orderItems.push({
            id: Date.now() + /*[[${itemStat.index}]]*/ 0,
            orderItemId: /*[[${item.id}]]*/ null,
            productId: /*[[${item.product.id}]]*/ 0,
            productName: /*[[${item.product.name}]]*/ '',
            productReference: /*[[${item.product.reference}]]*/ '',
            productUnit: /*[[${item.product.unit}]]*/ 'pièce',
            quantity: /*[[${item.quantity}]]*/ 1,
            unitPrice: /*[[${item.unitPrice}]]*/ 0,
            discountRate: /*[[${item.discountRate}]]*/ 0,
            discountAmount: /*[[${item.discountAmount}]]*/ 0,
            vatRate: /*[[${item.vatRate}]]*/ 20,
            totalPriceHT: /*[[${item.totalPriceHT}]]*/ 0,
            totalVatAmount: /*[[${item.totalVatAmount}]]*/ 0,
            totalPrice: /*[[${item.totalPrice}]]*/ 0
        });
        /*[/]*/
        
        // Fonctions globales pour la modal (copie de form.html)
        window.addProduct = function() {
            console.log('Ouverture de la modal personnalisée');
            
            loadProducts().then(() => {
                console.log('Produits chargés, affichage du modal');
                const modalElement = document.getElementById('productModal');
                if (modalElement) {
                    modalElement.style.cssText = `
                        position: fixed !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100vw !important;
                        height: 100vh !important;
                        z-index: 999999 !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        background: rgba(0,0,0,0.8) !important;
                    `;
                    
                    document.body.style.overflow = 'hidden';
                    modalElement.classList.add('show');
                    modalElement.focus();
                }
            });
        };

        window.selectProduct = function(productId) {
            console.log('Sélection du produit avec ID:', productId);
            
            const product = allProducts.find(p => p.id == productId);
            if (!product) {
                alert('Erreur: Produit non trouvé');
                return;
            }

            // Vérifier si le produit n'est pas déjà dans la commande
            const productIdInt = parseInt(productId);
            const existingItem = orderItems.find(item => parseInt(item.productId) === productIdInt);
            if (existingItem) {
                alert(`Ce produit "${product.name}" est déjà dans la commande.`);
                window.closeProductModal();
                return;
            }

            // Calculer les totaux
            const quantity = 1;
            const unitPrice = parseFloat(product.price) || 0;
            const vatRate = parseFloat(product.vatRate) || 20;
            const discountRate = 0;
            
            const subtotal = unitPrice * quantity;
            const discountAmount = subtotal * (discountRate / 100);
            const totalPriceHT = subtotal - discountAmount;
            const totalVatAmount = totalPriceHT * (vatRate / 100);
            const totalPrice = totalPriceHT + totalVatAmount;

            const uniqueId = Date.now() + Math.floor(Math.random() * 1000);
            
            const orderItem = {
                id: uniqueId,
                orderItemId: null,
                productId: parseInt(product.id),
                productName: product.name,
                productReference: product.reference || '',
                productUnit: product.unit || 'pièce',
                quantity: quantity,
                unitPrice: unitPrice,
                discountRate: discountRate,
                discountAmount: discountAmount,
                vatRate: vatRate,
                totalPriceHT: totalPriceHT,
                totalVatAmount: totalVatAmount,
                totalPrice: totalPrice
            };

            orderItems.push(orderItem);
            updateOrderItemsTable();
            calculateTotals();
            window.closeProductModal();
        };

        window.closeProductModal = function() {
            const modalElement = document.getElementById('productModal');
            if (modalElement) {
                modalElement.classList.remove('show');
                document.body.style.overflow = 'auto';
                setTimeout(() => {
                    modalElement.style.display = 'none';
                }, 300);
            }
        };
        
        window.updateQuantity = function(itemId, quantity) {
            const item = orderItems.find(i => i.id === itemId);
            if (item) {
                item.quantity = parseInt(quantity) || 1;
                calculateItemTotals(item);
                updateOrderItemsTable();
                calculateTotals();
            }
        };

        window.updateUnitPrice = function(itemId, price) {
            const item = orderItems.find(i => i.id === itemId);
            if (item) {
                item.unitPrice = parseFloat(price) || 0;
                calculateItemTotals(item);
                updateOrderItemsTable();
                calculateTotals();
            }
        };

        window.updateDiscountRate = function(itemId, discountRate) {
            const item = orderItems.find(i => i.id === itemId);
            if (item) {
                item.discountRate = parseFloat(discountRate) || 0;
                calculateItemTotals(item);
                updateOrderItemsTable();
                calculateTotals();
            }
        };

        window.removeOrderItem = function(itemId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet article ?')) {
                orderItems = orderItems.filter(item => item.id !== itemId);
                updateOrderItemsTable();
                calculateTotals();
            }
        };

        function calculateTotals() {
            let subtotalHT = 0;
            let totalVAT = 0;

            orderItems.forEach(item => {
                subtotalHT += item.totalPriceHT;
                totalVAT += item.totalVatAmount;
            });

            const totalTTC = subtotalHT + totalVAT;

            // Mettre à jour l'affichage
            const totalHTElement = document.getElementById('totalHT');
            const totalVATElement = document.getElementById('totalVAT');
            const totalTTCElement = document.getElementById('totalTTC');

            if (totalHTElement) totalHTElement.textContent = subtotalHT.toFixed(2) + ' €';
            if (totalVATElement) totalVATElement.textContent = totalVAT.toFixed(2) + ' €';
            if (totalTTCElement) totalTTCElement.textContent = totalTTC.toFixed(2) + ' €';
        }

        // Fonctions internes
        function loadProducts() {
            console.log('Chargement des produits...');
            
            return new Promise((resolve, reject) => {
                fetch('/orders/api/products')
                    .then(response => response.json())
                    .then(products => {
                        allProducts = products.map(product => ({
                            id: product.id,
                            name: product.name,
                            reference: product.reference || '',
                            price: parseFloat(product.unitPrice) || 0,
                            stock: product.stock || 0,
                            category: product.category || 'Non classé',
                            unit: product.unit || 'pièce',
                            vatRate: parseFloat(product.vatRate) || 20.0,
                            isActive: product.isActive !== false
                        }));
                        displayProducts(allProducts);
                        resolve();
                    })
                    .catch(error => {
                        console.warn('Erreur API, utilisation données demo');
                        allProducts = [
                            {id: 1, name: 'Produit Demo 1', reference: 'DEMO-001', price: 99.99, stock: 50, category: 'Demo', unit: 'pièce', vatRate: 20.0, isActive: true},
                            {id: 2, name: 'Produit Demo 2', reference: 'DEMO-002', price: 199.99, stock: 25, category: 'Demo', unit: 'pièce', vatRate: 20.0, isActive: true}
                        ];
                        displayProducts(allProducts);
                        resolve();
                    });
            });
        }

        function displayProducts(products) {
            const productList = document.getElementById('productList');
            if (!productList) return;
            
            productList.innerHTML = '';

            if (products.length === 0) {
                productList.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-3">
                            <i class="fas fa-search fa-2x mb-2"></i><br>
                            Aucun produit trouvé
                        </td>
                    </tr>
                `;
                return;
            }

            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <div class="bg-light rounded d-flex align-items-center justify-content-center"
                                     style="width: 40px; height: 40px;">
                                    <i class="fas fa-box text-secondary"></i>
                                </div>
                            </div>
                            <div>
                                <strong>${product.name}</strong><br>
                                <small class="text-muted">Réf: ${product.reference}</small>
                            </div>
                        </div>
                    </td>
                    <td class="text-end"><strong>${product.price.toFixed(2)} €</strong></td>
                    <td class="text-center">
                        <span class="badge ${product.stock > 10 ? 'bg-success' : product.stock > 0 ? 'bg-warning text-dark' : 'bg-danger'}">
                            ${product.stock} ${product.stock <= 1 ? 'unité' : 'unités'}
                        </span>
                    </td>
                    <td class="text-center">
                        <button type="button" 
                                class="btn btn-sm btn-success" 
                                onclick="window.selectProduct(${product.id})"
                                ${product.stock === 0 ? 'disabled' : ''}>
                            <i class="fas fa-plus me-1"></i>Ajouter
                        </button>
                    </td>
                `;
                productList.appendChild(row);
            });
        }

        function updateOrderItemsTable() {
            const tbody = document.getElementById('orderItemsBody');
            const emptyRow = document.getElementById('emptyRow');

            // Nettoyer le tableau
            tbody.innerHTML = '';
            tbody.appendChild(emptyRow);

            if (orderItems.length === 0) {
                emptyRow.style.display = '';
                updateHiddenInputs();
                return;
            }

            emptyRow.style.display = 'none';

            orderItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <div class="me-2">
                            <div class="bg-primary bg-opacity-10 rounded d-flex align-items-center justify-content-center"
                                 style="width: 32px; height: 32px;">
                                <i class="fas fa-box text-primary small"></i>
                            </div>
                        </div>
                        <div>
                            <strong>${item.productName}</strong><br>
                            <small class="text-muted">Réf: ${item.productReference} • ${item.productUnit}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm text-center"
                           value="${item.quantity}" min="1" max="999"
                           onchange="window.updateQuantity(${item.id}, this.value)"
                           style="width: 80px;">
                </td>
                <td>
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control text-end"
                               value="${item.unitPrice.toFixed(2)}" step="0.01" min="0"
                               onchange="window.updateUnitPrice(${item.id}, this.value)">
                        <span class="input-group-text">€</span>
                    </div>
                </td>
                <td>
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control text-end"
                               value="${item.discountRate.toFixed(2)}" step="0.01" min="0" max="100"
                               onchange="window.updateDiscountRate(${item.id}, this.value)">
                        <span class="input-group-text">%</span>
                    </div>
                </td>
                <td class="fw-bold text-end">${item.totalPriceHT.toFixed(2)} €</td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-danger"
                            onclick="window.removeOrderItem(${item.id})" title="Supprimer cet article">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
                tbody.insertBefore(row, emptyRow);
            });

            updateHiddenInputs();
        }

        function calculateItemTotals(item) {
            const subtotal = item.unitPrice * item.quantity;
            item.discountAmount = subtotal * (item.discountRate / 100);
            item.totalPriceHT = subtotal - item.discountAmount;
            item.totalVatAmount = item.totalPriceHT * (item.vatRate / 100);
            item.totalPrice = item.totalPriceHT + item.totalVatAmount;
        }

        let updateInputsTimeout = null;
        
        function updateHiddenInputs() {
            if (updateInputsTimeout) {
                clearTimeout(updateInputsTimeout);
            }
            
            updateInputsTimeout = setTimeout(() => {
                const container = document.getElementById('orderItemsInputs');
                if (!container) return;
                
                container.innerHTML = '';

                orderItems.forEach((item, index) => {
                    // Input pour l'ID de l'OrderItem (si existant)
                    if (item.orderItemId) {
                        const idInput = document.createElement('input');
                        idInput.type = 'hidden';
                        idInput.name = `orderItems[${index}].id`;
                        idInput.value = item.orderItemId;
                        container.appendChild(idInput);
                    }
                    
                    // Champs principaux de l'OrderItem
                    const orderItemFields = {
                        'quantity': item.quantity || 1,
                        'unitPrice': item.unitPrice || 0,
                        'discountRate': item.discountRate || 0,
                        'discountAmount': item.discountAmount || 0,
                        'vatRate': item.vatRate || 20,
                        'totalPriceHT': item.totalPriceHT || 0,
                        'totalVatAmount': item.totalVatAmount || 0,
                        'totalPrice': item.totalPrice || 0
                    };

                    Object.entries(orderItemFields).forEach(([field, value]) => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = `orderItems[${index}].${field}`;
                        input.value = value;
                        container.appendChild(input);
                    });
                    
                    // Référence au produit
                    const productInput = document.createElement('input');
                    productInput.type = 'hidden';
                    productInput.name = `orderItems[${index}].product.id`;
                    productInput.value = item.productId;
                    container.appendChild(productInput);
                });
                
                updateInputsTimeout = null;
            }, 50);
        }

        // Fonction utilitaire pour formater les montants
        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        function generateInvoicePreview() {
            const content = document.getElementById('invoicePreviewContent');
            const orderNumber = /*[[${ order.orderNumber}]]*/ '';
            const clientName = /*[[${ order.client.name}]]*/ '';
            const orderDate = /*[[${ #temporals.format(order.orderDate, 'dd/MM/yyyy')}]]*/ '';
            
            let totalHT = 0;
            let previewItems = '';
            
            // Parcourir les articles actuels dans le formulaire
            document.querySelectorAll('.order-item-row').forEach(row => {
                const productSelect = row.querySelector('.product-select');
                const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(row.querySelector('.price-input').value) || 0;
                const total = quantity * price;
                totalHT += total;
                
                if (productSelect.value && quantity > 0) {
                    const productName = productSelect.selectedOptions[0].text;
                    previewItems += `
                        <tr>
                            <td>${productName}</td>
                            <td class="text-center">${quantity}</td>
                            <td class="text-end">${formatCurrency(price)}</td>
                            <td class="text-end"><strong>${formatCurrency(total)}</strong></td>
                        </tr>
                    `;
                }
            });
            
            const vatAmount = totalHT * 0.20;
            const totalTTC = totalHT + vatAmount;
            
            const previewHtml = `
                <div class="invoice-preview">
                    <div class="row mb-4">
                        <div class="col-6">
                            <h4>GESCOM</h4>
                            <p class="mb-0">123 Rue Example</p>
                            <p class="mb-0">75000 Paris</p>
                        </div>
                        <div class="col-6 text-end">
                            <h5>FACTURE</h5>
                            <p class="mb-0">Basée sur: ${orderNumber}</p>
                            <p class="mb-0">Date: ${new Date().toLocaleDateString('fr-FR')}</p>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-6">
                            <h6>Client:</h6>
                            <p class="mb-0"><strong>${clientName}</strong></p>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Produit</th>
                                    <th class="text-center">Quantité</th>
                                    <th class="text-end">Prix unitaire</th>
                                    <th class="text-end">Total HT</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${previewItems}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="row">
                        <div class="col-6 offset-6">
                            <table class="table table-sm">
                                <tr>
                                    <td>Total HT:</td>
                                    <td class="text-end">${formatCurrency(totalHT)}</td>
                                </tr>
                                <tr>
                                    <td>TVA (20%):</td>
                                    <td class="text-end">${formatCurrency(vatAmount)}</td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>Total TTC:</strong></td>
                                    <td class="text-end"><strong>${formatCurrency(totalTTC)}</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = previewHtml;
        }

        // Fonction de validation simple pour le formulaire
        function validateOrderForm() {
            const client = document.getElementById('client');
            if (!client || !client.value) {
                alert('Veuillez sélectionner un client');
                return false;
            }
            return true;
        }

        // Initialisation de la page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Articles existants chargés:', orderItems.length);
            
            // Afficher les articles existants
            updateOrderItemsTable();
            calculateTotals();
            
            // Ajouter les écouteurs d'événements pour la modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    window.closeProductModal();
                }
            });
        });
    </script>
</div>
</body>
</html>