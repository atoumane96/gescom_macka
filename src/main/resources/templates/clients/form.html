<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::title}, ~{::content}, ~{::js_assets})}">
<head>
    <title th:text="${isEdit} ? 'Modifier le Client' : 'Nouveau Client'">Formulaire Client</title>
</head>
<body>
<div th:fragment="content">
    <!-- Page Header -->
    <div th:replace="~{fragments/components :: page-header(
        ${isEdit} ? 'Modifier le Client' : 'Nouveau Client', 
        ${isEdit} ? 'Modification des informations client' : 'Création d\'un nouveau client', 
        ~{::header-actions})}">
        <div th:fragment="header-actions">
            <a th:href="@{/clients}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Retour à la liste
            </a>
            <button type="submit" form="clientForm" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>
                <span th:text="${isEdit} ? 'Modifier' : 'Créer'">Enregistrer</span>
            </button>
        </div>
    </div>

    <!-- Formulaire -->
    <div class="row">
        <div class="col-lg-8">
            <div class="section-card card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>Informations du Client</h5>
                </div>
                <div class="card-body">
                    <form id="clientForm" th:action="@{/clients}" th:object="${client}" method="post" novalidate>
                        <!-- ID caché pour modification -->
                        <input type="hidden" th:field="*{id}">

                        <!-- Informations générales -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-info-circle me-2"></i>Informations Générales
                                </h6>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="name" class="form-label">Nom complet <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" th:field="*{name}"
                                       th:classappend="${#fields.hasErrors('name')} ? 'is-invalid'"
                                       placeholder="Nom et prénom ou raison sociale" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}" th:errors="*{name}">
                                    Erreur nom
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="email" th:field="*{email}"
                                       th:classappend="${#fields.hasErrors('email')} ? 'is-invalid'"
                                       placeholder="email@example.com" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('email')}" th:errors="*{email}">
                                    Erreur email
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="phoneNumber" class="form-label">Téléphone</label>
                                <input type="tel" class="form-control" id="phoneNumber" th:field="*{phoneNumber}"
                                       placeholder="+33 1 23 45 67 89">
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="mobileNumber" class="form-label">Mobile</label>
                                <input type="tel" class="form-control" id="mobileNumber" th:field="*{mobileNumber}"
                                       placeholder="+33 6 12 34 56 78">
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="clientType" class="form-label">Type de client <span class="text-danger">*</span></label>
                                <select class="form-select" id="clientType" th:field="*{clientType}" required>
                                    <option value="">Sélectionner le type</option>
                                    <option value="INDIVIDUAL">Particulier</option>
                                    <option value="COMPANY">Entreprise</option>
                                    <option value="ASSOCIATION">Association</option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-3" id="companyFields" style="display: none;">
                                <label for="companyName" class="form-label">Nom de l'entreprise</label>
                                <input type="text" class="form-control" id="companyName" th:field="*{companyName}"
                                       placeholder="Nom de l'entreprise">
                            </div>

                            <div class="col-md-6 mb-3" id="siretField" style="display: none;">
                                <label for="siretNumber" class="form-label">SIRET</label>
                                <input type="text" class="form-control" id="siretNumber" th:field="*{siretNumber}"
                                       placeholder="123 456 789 00012">
                            </div>

                            <div class="col-md-6 mb-3" id="vatField" style="display: none;">
                                <label for="vatNumber" class="form-label">Numéro TVA</label>
                                <input type="text" class="form-control" id="vatNumber" th:field="*{vatNumber}"
                                       placeholder="FR12345678901">
                            </div>
                        </div>

                        <!-- Adresse -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-map-marker-alt me-2"></i>Adresse
                                </h6>
                            </div>

                            <div class="col-12 mb-3">
                                <label for="address" class="form-label">Adresse</label>
                                <input type="text" class="form-control" id="address" th:field="*{address}"
                                       placeholder="Numéro et nom de rue">
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="postalCode" class="form-label">Code postal</label>
                                <input type="text" class="form-control" id="postalCode" th:field="*{postalCode}"
                                       placeholder="75001">
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="city" class="form-label">Ville</label>
                                <input type="text" class="form-control" id="city" th:field="*{city}"
                                       placeholder="Paris">
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="country" class="form-label">Pays</label>
                                <input type="text" class="form-control" id="country" th:field="*{country}"
                                       placeholder="France" value="France">
                            </div>
                        </div>

                        <!-- Gestion -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-cogs me-2"></i>Gestion
                                </h6>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="status" class="form-label">Statut <span class="text-danger">*</span></label>
                                <select class="form-select" id="status" th:field="*{status}" required>
                                    <option value="">Sélectionner le statut</option>
                                    <option value="ACTIVE">Actif</option>
                                    <option value="INACTIVE">Inactif</option>
                                    <option value="PROSPECT">Prospect</option>
                                    <option value="BLOCKED">Bloqué</option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="assignedUser" class="form-label">Commercial assigné</label>
                                <select class="form-select" id="assignedUser" th:field="*{assignedUser}">
                                    <option value="">Aucun commercial assigné</option>
                                    <option th:each="commercial : ${commercials}"
                                            th:value="${commercial.id}"
                                            th:text="${commercial.fullName}">
                                        Commercial
                                    </option>
                                </select>
                            </div>

                            <div class="col-12 mb-3">
                                <label for="notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="notes" th:field="*{notes}" rows="3"
                                          placeholder="Notes et commentaires sur le client..."></textarea>
                            </div>

                            <div class="col-md-6 mb-3" id="followUpDate" style="display: none;">
                                <label for="followUpDate" class="form-label">Date de relance</label>
                                <input type="datetime-local" class="form-control" id="followUpDateInput" th:field="*{followUpDate}">
                            </div>
                        </div>

                        <!-- Boutons -->
                        <div class="row">
                            <div class="col-12">
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <a th:href="@{/clients}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-2"></i>Annuler
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>
                                        <span th:text="${isEdit} ? 'Modifier' : 'Créer'">Enregistrer</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Panel d'aide -->
        <div class="col-lg-4">
            <div class="section-card card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Aide</h6>
                </div>
                <div class="card-body">
                    <h6>Types de clients :</h6>
                    <ul class="list-unstyled">
                        <li><span class="badge bg-info me-2">Entreprise</span> Pour les sociétés</li>
                        <li><span class="badge bg-secondary me-2">Particulier</span> Pour les individus</li>
                    </ul>

                    <h6 class="mt-3">Statuts :</h6>
                    <ul class="list-unstyled">
                        <li><span class="badge bg-success me-2">Actif</span> Client confirmé</li>
                        <li><span class="badge bg-warning me-2">Prospect</span> Client potentiel</li>
                        <li><span class="badge bg-secondary me-2">Inactif</span> Client suspendu</li>
                    </ul>

                    <div class="alert alert-info mt-3">
                        <small>
                            <i class="fas fa-lightbulb me-2"></i>
                            <strong>Conseil :</strong> Assignez toujours un commercial aux nouveaux clients pour un meilleur suivi.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript pour la gestion du formulaire -->
<th:block th:fragment="js_assets">
    <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const clientTypeSelect = document.getElementById('clientType');
        const companyFields = document.getElementById('companyFields');
        const siretField = document.getElementById('siretField');
        const vatField = document.getElementById('vatField');
        const statusSelect = document.getElementById('status');
        const followUpDateDiv = document.getElementById('followUpDate');

        // Gestion des champs entreprise
        function toggleCompanyFields() {
            const isCompany = clientTypeSelect.value === 'COMPANY' || clientTypeSelect.value === 'ASSOCIATION';
            companyFields.style.display = isCompany ? 'block' : 'none';
            siretField.style.display = isCompany ? 'block' : 'none';
            vatField.style.display = isCompany ? 'block' : 'none';

            // Rendre obligatoire le nom d'entreprise si c'est une entreprise
            const companyNameInput = document.getElementById('companyName');
            if (isCompany) {
                companyNameInput.required = true;
            } else {
                companyNameInput.required = false;
            }
        }

        // Gestion du champ de relance pour les prospects
        function toggleFollowUpDate() {
            const isProspect = statusSelect.value === 'PROSPECT';
            followUpDateDiv.style.display = isProspect ? 'block' : 'none';
        }

        // Event listeners
        clientTypeSelect.addEventListener('change', toggleCompanyFields);
        statusSelect.addEventListener('change', toggleFollowUpDate);

        // Initialisation
        toggleCompanyFields();
        toggleFollowUpDate();

        // Validation du formulaire
        const form = document.querySelector('form');
        form.addEventListener('submit', function(event) {
            const email = document.getElementById('email');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!emailRegex.test(email.value)) {
                event.preventDefault();
                email.classList.add('is-invalid');
                return false;
            }

            return true;
        });

        // Auto-complétion de la ville avec le code postal (optionnel)
        const postalCodeInput = document.getElementById('postalCode');
        const cityInput = document.getElementById('city');

        postalCodeInput.addEventListener('blur', function() {
            const postalCode = this.value;
            if (postalCode.length === 5 && /^\d+$/.test(postalCode)) {
                // Ici vous pourriez ajouter une API de géolocalisation
                // Pour l'instant, juste des exemples statiques
                const cityMapping = {
                    '75001': 'Paris',
                    '69001': 'Lyon',
                    '13001': 'Marseille',
                    '31000': 'Toulouse',
                    '33000': 'Bordeaux'
                };

                if (cityMapping[postalCode] && !cityInput.value) {
                    cityInput.value = cityMapping[postalCode];
                }
            }
        });
    });
</script>
</th:block>
</body>
</html>