<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::title}, ~{::content}, ~{::js_assets})}">
<head>
    <title th:text="'Détails - ' + ${product?.name ?: 'Produit'}">Détails du Produit</title>
</head>
<body>
<div th:fragment="content" class="product-detail-page">
    <!-- Vérification que le produit existe -->
    <div th:if="${product == null}" class="alert alert-danger">
        <h4><i class="fas fa-exclamation-triangle me-2"></i>Produit introuvable</h4>
        <p>Le produit demandé n'existe pas ou a été supprimé.</p>
        <a th:href="@{/products}" class="btn btn-primary">Retour à la liste des produits</a>
    </div>

    <!-- Contenu principal si le produit existe -->
    <div th:if="${product != null}">
        <!-- Page Header -->
        <div th:replace="~{fragments/components :: page-header(
            'Produit ' + ${product.name}, 
            'Détails et informations du produit', 
            ~{::header-actions})}">
            <div th:fragment="header-actions" class="action-buttons">
                <a th:href="@{/products}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Retour à la liste
                </a>
                <button type="button" class="btn btn-outline-primary" onclick="printProduct()">
                    <i class="fas fa-print"></i>
                    Imprimer
                </button>
                <button type="button" class="btn btn-outline-info" onclick="exportProduct()">
                    <i class="fas fa-download"></i>
                    Exporter
                </button>
                <div class="dropdown">
                    <button class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-cogs"></i>
                        Actions
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" th:href="@{/products/{id}/edit(id=${product.id})}">
                            <i class="fas fa-edit me-2"></i>Modifier
                        </a></li>
                        <li><a class="dropdown-item" th:href="@{'/products/duplicate/' + ${product.id}}">
                            <i class="fas fa-copy me-2"></i>Dupliquer
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="adjustStock()">
                            <i class="fas fa-boxes me-2"></i>Ajuster stock
                        </a></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteProduct()">
                            <i class="fas fa-ban me-2"></i>Supprimer
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Product Summary -->
        <div class="order-header">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <div class="d-flex align-items-center mb-3">
                        <h2 class="mb-0 me-3" th:text="${product.name}">Nom Produit</h2>
                        <span th:switch="${product.isActive}" class="status-badge">
                            <span th:case="true" class="badge bg-success">Actif</span>
                            <span th:case="false" class="badge bg-secondary">Inactif</span>
                            <span th:case="*" class="badge bg-secondary">Inconnu</span>
                        </span>
                        <span class="badge bg-primary ms-2" th:if="${product.isFeatured != null && product.isFeatured}">
                            <i class="fas fa-star me-1"></i>Mis en avant
                        </span>
                        <span class="badge bg-warning ms-1" th:if="${product.lowStock}">
                            <i class="fas fa-exclamation-triangle me-1"></i>Stock bas
                        </span>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6" th:if="${product.reference}">
                            <div class="d-flex align-items-center text-secondary">
                                <i class="fas fa-barcode me-2 text-primary"></i>
                                <span class="fw-bold">Référence Produit</span>
                            </div>
                            <div class="fw-semibold text-dark">
                                <code class="bg-light px-2 py-1 rounded text-primary" th:text="${product.reference}">REF-001</code>
                            </div>
                        </div>
                        
                        <div class="col-md-6" th:if="${product.category}">
                            <div class="d-flex align-items-center text-secondary">
                                <i class="fas fa-tags me-2 text-success"></i>
                                <span class="fw-bold">Catégorie Produit</span>
                            </div>
                            <div class="fw-semibold text-dark">
                                <span class="badge bg-success bg-opacity-10 text-success px-3 py-2" th:text="${product.category}">Électronique</span>
                            </div>
                        </div>
                        
                        <div class="col-md-6" th:if="${product.unitPrice}">
                            <div class="d-flex align-items-center text-secondary">
                                <i class="fas fa-euro-sign me-2 text-warning"></i>
                                <span class="fw-bold">Prix de Vente</span>
                            </div>
                            <div class="fw-bold text-warning fs-5" th:text="${#numbers.formatCurrency(product.unitPrice)}">€99.99</div>
                        </div>
                        
                        <div class="col-md-6" th:if="${product.stock != null}">
                            <div class="d-flex align-items-center text-secondary">
                                <i class="fas fa-warehouse me-2 text-info"></i>
                                <span class="fw-bold">Stock Disponible</span>
                            </div>
                            <div class="fw-bold fs-5">
                                <span th:text="${product.stock}" th:class="${product.lowStock} ? 'text-warning' : 'text-success'">150</span>
                                <small class="text-dark ms-1" th:text="${product.unit ?: 'unité(s)'}">unité(s)</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <!-- Galerie d'images du produit -->
                    <div class="product-image-gallery">
                        <div class="main-image-container" id="productImageContainer">
                            <div th:if="${product.imageUrl != null and not #strings.isEmpty(product.imageUrl)}">
                                <img th:src="${product.imageUrl}" 
                                     th:alt="${product.name}" 
                                     class="img-fluid rounded shadow-lg main-product-image"
                                     id="mainProductImage"
                                     style="max-height: 300px; width: 100%; object-fit: cover;">
                            </div>
                            <div th:unless="${product.imageUrl != null and not #strings.isEmpty(product.imageUrl)}" 
                                 class="no-image-placeholder">
                                <div class="placeholder-content text-center p-5 bg-light rounded">
                                    <i class="fas fa-image fa-4x text-muted mb-3"></i>
                                    <h6 class="text-muted">Aucune image disponible</h6>
                                    <p class="small text-muted mb-3">Image du produit non fournie</p>
                                    <a th:href="@{/products/{id}/edit(id=${product.id})}" 
                                       class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-plus me-1"></i>Ajouter une image
                                    </a>
                                </div>
                            </div>
                            <!-- Message d'erreur si l'image ne se charge pas -->
                            <div id="imageError" style="display: none;" class="text-center p-4 bg-danger bg-opacity-10 rounded">
                                <i class="fas fa-exclamation-triangle text-danger mb-2"></i>
                                <p class="text-danger mb-0">Impossible de charger l'image</p>
                            </div>
                        </div>
                        
                        <!-- Actions sur l'image -->
                        <div class="image-actions mt-3 text-center">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportProduct()" title="Exporter la fiche">
                                    <i class="fas fa-download me-1"></i>Export
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="printProduct()" title="Imprimer la fiche">
                                    <i class="fas fa-print me-1"></i>Imprimer
                                </button>
                                <a th:href="@{/products/{id}/edit(id=${product.id})}" 
                                   class="btn btn-outline-secondary btn-sm" title="Modifier le produit">
                                    <i class="fas fa-edit me-1"></i>Modifier
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Colonne principale -->
            <div class="col-lg-8">
                <!-- Informations générales -->
                <div class="section-card card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations Générales</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="fw-bold text-primary">📋 Référence Produit</label>
                                <p class="mb-0 text-dark fw-semibold" th:text="${product.reference ?: 'Référence non définie'}">REF-001</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="fw-bold text-success">🏷️ Catégorie Produit</label>
                                <p class="mb-0">
                                    <span class="badge bg-success text-white fs-6 px-3 py-2" th:text="${product.category ?: 'Catégorie non définie'}">Électronique</span>
                                </p>
                            </div>
                            <div class="col-md-6 mb-3" th:if="${product.brand != null and #strings.length(product.brand) > 0}">
                                <label class="fw-bold text-info">🔖 Marque du Produit</label>
                                <p class="mb-0 text-dark fw-semibold fs-5" th:text="${product.brand}">Samsung</p>
                            </div>
                            <div class="col-md-6 mb-3" th:if="${product.barCode != null and #strings.length(product.barCode) > 0}">
                                <label class="fw-bold text-warning">📊 Code-Barres</label>
                                <p class="mb-0 font-monospace bg-light px-2 py-1 rounded text-dark fw-bold" th:text="${product.barCode}">1234567890123</p>
                            </div>
                            <div class="col-12" th:if="${product.description != null and #strings.length(product.description) > 0}">
                                <label class="fw-bold text-dark">📝 Description Détaillée</label>
                                <p class="mb-0 text-dark lh-lg" th:text="${product.description}">Description complète du produit avec toutes ses caractéristiques...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prix et Stock -->
                <div class="section-card card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-euro-sign me-2"></i>Prix et Stock</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <h4 class="text-primary mb-1" th:text="${product.unitPrice != null ? (#numbers.formatDecimal(product.unitPrice, 1, 2) + ' €') : 'N/A'}">99.99 €</h4>
                                    <small class="text-muted">Prix unitaire HT</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <h4 class="text-success mb-1" th:text="${product.priceIncludingVat != null ? (#numbers.formatDecimal(product.priceIncludingVat, 1, 2) + ' €') : 'N/A'}">119.99 €</h4>
                                    <small class="text-muted">Prix TTC</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3" th:if="${product.purchasePrice != null}">
                                <div class="text-center p-3 bg-light rounded">
                                    <h4 class="text-info mb-1" th:text="${#numbers.formatDecimal(product.purchasePrice, 1, 2) + ' €'}">79.99 €</h4>
                                    <small class="text-muted">Prix d'achat</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3" th:if="${product.purchasePrice != null and product.unitPrice != null}">
                                <div class="text-center p-3 bg-light rounded">
                                    <h4 class="text-warning mb-1" th:text="${#numbers.formatDecimal(product.unitPrice - product.purchasePrice, 1, 2) + ' €'}">20.00 €</h4>
                                    <small class="text-muted">Marge</small>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="fw-bold text-primary">📦 Stock Actuel en Magasin</label>
                                <div class="d-flex align-items-center">
                                    <h3 class="mb-0 me-2"
                                        th:class="'mb-0 me-2 ' + (${product.outOfStock} ? 'text-danger' : (${product.lowStock} ? 'text-warning' : 'text-success'))"
                                        th:text="${(product.stock ?: 0)} + ' ' + ${product.unit ?: 'pièce'}">150 pièces</h3>
                                    <span class="badge"
                                          th:class="'badge ' + (${product.outOfStock} ? 'bg-danger' : (${product.lowStock} ? 'bg-warning' : 'bg-success'))"
                                          th:text="${product.outOfStock} ? 'Rupture' : (${product.lowStock} ? 'Faible' : 'Correct')">Correct</span>
                                </div>
                                <div class="progress mt-2" style="height: 8px;">
                                    <div class="progress-bar"
                                         th:class="'progress-bar ' + (${product.outOfStock} ? 'bg-danger' : (${product.lowStock} ? 'bg-warning' : 'bg-success'))"
                                         th:style="'width: ' + (${product.maxStock != null and product.maxStock > 0} ? (${(product.stock ?: 0) * 100 / product.maxStock}) : 50) + '%'"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="fw-bold text-warning">⚠️ Seuil d'Alerte (Stock Minimum)</label>
                                <p class="mb-0 h5" th:text="${(product.minStock ?: 0)} + ' ' + ${product.unit ?: 'pièce'}">10 pièces</p>
                            </div>
                            <div class="col-md-4 mb-3" th:if="${product.maxStock != null and product.maxStock > 0}">
                                <label class="fw-bold text-success">✅ Capacité Maximale de Stockage</label>
                                <p class="mb-0 h5" th:text="${product.maxStock} + ' ' + ${product.unit ?: 'pièce'}">500 pièces</p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3" th:if="${product.vatRate != null}">
                                <label class="fw-bold text-info">💰 Taux de TVA Applicable</label>
                                <p class="mb-0 text-dark fw-bold fs-5">
                                    <span class="badge bg-info text-white px-3 py-2" th:text="${product.vatRate} + '%'">20%</span>
                                </p>
                            </div>
                            <div class="col-md-6 mb-3" th:if="${product.weight != null and product.weight.compareTo(T(java.math.BigDecimal).ZERO) > 0}">
                                <label class="fw-bold text-secondary">⚖️ Poids du Produit</label>
                                <p class="mb-0 text-dark fw-bold fs-5" th:text="${#numbers.formatDecimal(product.weight, 1, 3)} + ' kg'">1.500 kg</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="section-card card mb-4" th:if="${product.notes != null and #strings.length(product.notes) > 0}">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-sticky-note me-2"></i>Notes</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-0" th:text="${product.notes}">Notes sur le produit...</p>
                    </div>
                </div>
            </div>

            <!-- Colonne latérale -->
            <div class="col-lg-4">
                <!-- Image du produit -->
                <div class="section-card card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-image me-2"></i>Image du Produit</h6>
                    </div>
                    <div class="card-body text-center">
                        <!-- Image principale -->
                        <div th:if="${product.imageUrl != null and #strings.length(product.imageUrl) > 0}" id="productImageContainer">
                            <img th:src="${product.imageUrl}"
                                 th:alt="${product.name}"
                                 class="img-fluid rounded shadow"
                                 style="max-height: 300px; cursor: pointer;"
                                 onclick="openImageModal(this.src)"
                                 onerror="showImageError()">
                        </div>

                        <!-- Placeholder si pas d'image -->
                        <div th:if="${product.imageUrl == null or #strings.length(product.imageUrl) == 0}"
                             class="bg-light rounded d-flex align-items-center justify-content-center"
                             style="height: 200px; border: 2px dashed #dee2e6;">
                            <div class="text-center text-muted">
                                <i class="fas fa-image fa-3x mb-2"></i>
                                <p class="mb-0">Aucune image disponible</p>
                                <small>Cliquez sur Modifier pour ajouter une image</small>
                            </div>
                        </div>

                        <!-- Erreur de chargement d'image -->
                        <div id="imageError" style="display: none;"
                             class="bg-light rounded d-flex align-items-center justify-content-center text-danger">
                            <div class="text-center">
                                <i class="fas fa-exclamation-triangle fa-3x mb-2"></i>
                                <p class="mb-0">Erreur de chargement de l'image</p>
                                <small>Vérifiez l'URL de l'image</small>
                            </div>
                        </div>

                        <!-- Informations sur l'image -->
                        <div th:if="${product.imageUrl != null and #strings.length(product.imageUrl) > 0}" class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Cliquez sur l'image pour l'agrandir
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Actions rapides -->
                <div class="section-card card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Actions Rapides</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="adjustStock()">
                                <i class="fas fa-boxes me-2"></i>Ajuster le stock
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="createOrder()">
                                <i class="fas fa-shopping-cart me-2"></i>Créer une commande
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="updatePrice()">
                                <i class="fas fa-tag me-2"></i>Modifier le prix
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="changeImage()">
                                <i class="fas fa-image me-2"></i>Changer l'image
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="generateBarcode()">
                                <i class="fas fa-barcode me-2"></i>Générer code-barres
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Informations système -->
                <div class="section-card card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info me-2"></i>Informations Système</h6>
                    </div>
                    <div class="card-body">
                        <div class="text-dark" th:if="${product.createdAt != null}">
                            <strong class="text-success">📅 Date de Création :</strong><br>
                            <span class="fw-semibold" th:text="${#temporals.format(product.createdAt, 'dd/MM/yyyy à HH:mm')}">25/07/2025 à 10:30</span>
                        </div><br>
                        <div class="text-dark" th:if="${product.updatedAt != null}">
                            <strong class="text-warning">🔄 Dernière Modification :</strong><br>
                            <span class="fw-semibold" th:text="${#temporals.format(product.updatedAt, 'dd/MM/yyyy à HH:mm')}">25/07/2025 à 14:15</span>
                        </div><br>
                        <div class="text-dark">
                            <strong class="text-primary">🆔 Identifiant Unique :</strong> 
                            <span class="badge bg-primary px-2 py-1" th:text="'#' + ${product.id}">#123</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'agrandissement d'image -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">
                    <i class="fas fa-image me-2"></i>Image du Produit
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body text-center p-0 position-relative">
                <img id="modalImage"
                     src=""
                     alt="Image du produit"
                     class="img-fluid w-100"
                     style="max-height: 70vh; width: auto; cursor: zoom-in;">
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="toggleFullscreen()" title="Plein écran (F)">
                        <i class="fas fa-expand me-2"></i>Plein écran
                    </button>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="downloadImage()" title="Télécharger (Ctrl+D)">
                        <i class="fas fa-download me-2"></i>Télécharger
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Fermer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'ajustement de stock -->
<div class="modal fade" id="stockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajuster le Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="stockForm">
                    <div class="mb-3">
                        <label class="form-label">Stock actuel</label>
                        <input type="text" class="form-control" th:value="${product.stock}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type d'ajustement</label>
                        <label for="adjustmentType"></label><select class="form-select" id="adjustmentType">
                            <option value="add">Ajouter au stock</option>
                            <option value="remove">Retirer du stock</option>
                            <option value="set">Définir le stock exact</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantité</label>
                        <input type="number" class="form-control" id="quantity" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Motif</label>
                        <select class="form-select" id="reason">
                            <option value="restock">Réapprovisionnement</option>
                            <option value="sale">Vente</option>
                            <option value="damage">Produit endommagé</option>
                            <option value="inventory">Inventaire</option>
                            <option value="other">Autre</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Commentaire (optionnel)</label>
                        <textarea class="form-control" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveStockAdjustment()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer ce produit ?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Cette action est irréversible et supprimera également tout l'historique associé.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Supprimer</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<th:block th:fragment="js_assets">
    <script th:inline="javascript">
    // Fonctions pour la gestion des images
    function openImageModal(imageSrc) {
        try {
            if (!imageSrc || imageSrc.trim() === '') {
                console.error('URL d\'image vide ou invalide');
                return;
            }

            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = modal.querySelector('.modal-title');

            if (!modal || !modalImage) {
                console.error('Éléments de la modal introuvables');
                return;
            }

            const productName = document.querySelector('h1 span').textContent || 'Produit';
            modalTitle.textContent = `Image - ${productName}`;

            modalImage.src = imageSrc;
            modalImage.alt = `Image de ${productName}`;

            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();

        } catch (error) {
            console.error('Erreur dans openImageModal:', error);
        }
    }

    function showImageError() {
        const container = document.getElementById('productImageContainer');
        const errorDiv = document.getElementById('imageError');
        if (container && errorDiv) {
            container.style.display = 'none';
            errorDiv.style.display = 'block';
        }
    }

    function downloadImage() {
        try {
            const modalImage = document.getElementById('modalImage');
            const productName = document.querySelector('h1 span').textContent || 'produit';

            if (!modalImage || !modalImage.src) {
                alert('Aucune image à télécharger');
                return;
            }

            const link = document.createElement('a');
            link.href = modalImage.src;
            link.download = productName.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.jpg';
            link.style.display = 'none';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        } catch (error) {
            console.error('Erreur lors du téléchargement:', error);
            alert('Erreur lors du téléchargement');
        }
    }

    function toggleFullscreen() {
        const modal = document.getElementById('imageModal');
        const modalDialog = modal.querySelector('.modal-dialog');
        const fullscreenBtn = modal.querySelector('[onclick="toggleFullscreen()"]');

        if (modalDialog.classList.contains('modal-fullscreen')) {
            modalDialog.classList.remove('modal-fullscreen');
            modalDialog.classList.add('modal-lg');
            fullscreenBtn.innerHTML = '<i class="fas fa-expand me-2"></i>Plein écran';
        } else {
            modalDialog.classList.remove('modal-lg');
            modalDialog.classList.add('modal-fullscreen');
            fullscreenBtn.innerHTML = '<i class="fas fa-compress me-2"></i>Réduire';
        }
    }

    // Fonction pour changer l'image
    function changeImage() {
        const newImageUrl = prompt('Nouvelle URL d\'image:', '');
        if (newImageUrl && newImageUrl.trim() !== '') {
            console.log('Nouvelle URL d\'image:', newImageUrl.trim());
            // Ici, vous implémenteriez la sauvegarde via AJAX
            alert('Fonctionnalité à implémenter côté serveur');
        }
    }

    // Fonctions pour les actions
    function deleteProduct() {
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
    }

    function confirmDelete() {
        const productId = window.location.pathname.split('/').pop();
        window.location.href = `/products/delete/${productId}`;
    }

    function adjustStock() {
        const stockModal = new bootstrap.Modal(document.getElementById('stockModal'));
        stockModal.show();
    }

    function saveStockAdjustment() {
        const form = document.getElementById('stockForm');
        const formData = new FormData(form);

        console.log('Ajustement de stock:', Object.fromEntries(formData));

        bootstrap.Modal.getInstance(document.getElementById('stockModal')).hide();
        alert('Ajustement de stock enregistré (fonctionnalité à implémenter)');
    }

    function createOrder() {
        const productId = window.location.pathname.split('/').pop();
        window.location.href = `/orders/new?productId=${productId}`;
    }

    function updatePrice() {
        const currentPrice = prompt('Nouveau prix unitaire (€):', '0.00');
        if (currentPrice && !isNaN(currentPrice) && parseFloat(currentPrice) > 0) {
            console.log('Nouveau prix:', currentPrice);
            alert('Mise à jour du prix (fonctionnalité à implémenter)');
        }
    }

    function generateBarcode() {
        const productId = window.location.pathname.split('/').pop();
        window.open(`/products/barcode/${productId}`, '_blank');
    }

    function printProduct() {
        window.print();
    }

    function exportProduct() {
        const productId = window.location.pathname.split('/').pop();
        window.location.href = `/products/export/${productId}`;
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page de détails du produit chargée');
    });
</script>

<style>
    /* CORRECTION ABSOLUE DES TEXTES BLANCS */
    .product-detail-page,
    .product-detail-page * {
        color: #111827 !important;
        --bs-text-opacity: 1 !important;
    }
    
    /* Réinitialisation complète des couleurs */
    .product-detail-page .text-muted,
    .product-detail-page .text-secondary,
    .product-detail-page .text-dark,
    .product-detail-page p,
    .product-detail-page span:not(.badge),
    .product-detail-page div:not(.badge),
    .product-detail-page label,
    .product-detail-page .fw-semibold,
    .product-detail-page .fw-bold,
    .product-detail-page .card-body *,
    .product-detail-page h1, .product-detail-page h2, .product-detail-page h3,
    .product-detail-page h4, .product-detail-page h5, .product-detail-page h6 {
        color: #111827 !important;
        opacity: 1 !important;
    }
    
    /* Désactivation du mode sombre pour cette page */
    .product-detail-page {
        --white: #ffffff !important;
        --gray-700: #374151 !important;
        --gray-900: #111827 !important;
        background-color: #ffffff !important;
    }
    
    /* Labels colorés mais lisibles */
    .product-detail-page .fw-bold.text-primary {
        color: #1d4ed8 !important;
        font-weight: 700 !important;
    }
    
    .product-detail-page .fw-bold.text-success {
        color: #059669 !important;
        font-weight: 700 !important;
    }
    
    .product-detail-page .fw-bold.text-warning {
        color: #d97706 !important;
        font-weight: 700 !important;
    }
    
    .product-detail-page .fw-bold.text-info {
        color: #0891b2 !important;
        font-weight: 700 !important;
    }
    
    .product-detail-page .fw-bold.text-secondary {
        color: #64748b !important;
        font-weight: 700 !important;
    }
    
    /* Badges avec contrastes */
    .product-detail-page .badge {
        font-weight: 600 !important;
        font-size: 0.85rem !important;
        padding: 0.5rem 0.75rem !important;
    }
    
    .product-detail-page .badge.bg-success {
        background-color: #10b981 !important;
        color: #ffffff !important;
    }
    
    .product-detail-page .badge.bg-primary {
        background-color: #3b82f6 !important;
        color: #ffffff !important;
    }
    
    .product-detail-page .badge.bg-warning {
        background-color: #f59e0b !important;
        color: #ffffff !important;
    }
    
    .product-detail-page .badge.bg-info {
        background-color: #06b6d4 !important;
        color: #ffffff !important;
    }
    
    /* Arrière-plans clairs */
    .product-detail-page .bg-light {
        background-color: #f8fafc !important;
        color: #111827 !important;
        border: 1px solid #e5e7eb !important;
    }
    
    /* Titres de cartes */
    .product-detail-page .card-header,
    .product-detail-page .card-header * {
        color: #111827 !important;
        background-color: #f9fafb !important;
    }
    
    /* Code et monospace */
    .product-detail-page code,
    .product-detail-page .font-monospace {
        background-color: #f3f4f6 !important;
        color: #1f2937 !important;
        padding: 0.25rem 0.5rem !important;
        border-radius: 0.375rem !important;
    }

    /* === GALERIE D'IMAGES PRODUIT === */
    .product-detail-page .product-image-gallery {
        position: relative;
    }

    .product-detail-page .main-image-container {
        position: relative;
        overflow: hidden;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        background: #ffffff;
    }

    .product-detail-page .main-product-image {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: zoom-in;
    }

    .product-detail-page .main-product-image:hover {
        transform: scale(1.05);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .product-detail-page .no-image-placeholder {
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .product-detail-page .placeholder-content {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%) !important;
        border: 2px dashed #cbd5e1 !important;
        transition: all 0.3s ease;
    }

    .product-detail-page .placeholder-content:hover {
        border-color: #3b82f6 !important;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%) !important;
        transform: translateY(-2px);
    }

    .product-detail-page .image-actions .btn-group {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
    }

    .product-detail-page .image-actions .btn {
        border: none !important;
        padding: 8px 16px !important;
        font-weight: 500 !important;
        transition: all 0.3s ease !important;
    }

    .product-detail-page .image-actions .btn:hover {
        transform: translateY(-1px) !important;
    }

    .product-detail-page #imageError {
        border: 2px dashed #ef4444 !important;
        border-radius: 12px;
        animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    
    @media print {
        .btn, .dropdown, nav, .card-header .btn {
            display: none !important;
        }

        .card {
            border: 1px solid #dee2e6 !important;
            box-shadow: none !important;
        }
    }

    .progress {
        background-color: #e9ecef;
    }

    .badge {
        font-size: 0.75em;
    }

    .card-body h4 {
        font-weight: 600;
    }

    #productImageContainer img {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid #dee2e6;
    }

    #productImageContainer img:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    #imageError {
        height: 200px;
        border: 2px dashed #dc3545;
    }

    .card {
        transition: all 0.3s ease;
    }

    .card:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
</style>

<script>
// === GESTION DES IMAGES PRODUIT ===
document.addEventListener('DOMContentLoaded', function() {
    const mainImage = document.getElementById('mainProductImage');
    const imageError = document.getElementById('imageError');
    
    // Gestion des erreurs de chargement d'image
    if (mainImage) {
        mainImage.addEventListener('error', function() {
            this.style.display = 'none';
            if (imageError) {
                imageError.style.display = 'block';
            }
        });
        
        mainImage.addEventListener('load', function() {
            if (imageError) {
                imageError.style.display = 'none';
            }
        });
        
        // Zoom sur clic
        mainImage.addEventListener('click', function() {
            openImageModal(this.src, this.alt);
        });
    }
    
    console.log('Page de détails du produit chargée avec support des images');
});

// === FONCTIONS UTILITAIRES ===
function openImageModal(imageSrc, imageAlt) {
    // Créer une modale pour afficher l'image en grand
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">${imageAlt}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="${imageSrc}" alt="${imageAlt}" class="img-fluid rounded" style="max-height: 70vh;">
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
    
    bootstrapModal.show();
}

function printProduct() {
    window.print();
}

function exportProduct() {
    // Créer un export simple du produit
    const productName = document.querySelector('h2').textContent;
    const productData = {
        nom: productName,
        reference: document.querySelector('[th\\:text*="reference"]')?.textContent,
        exportDate: new Date().toLocaleDateString('fr-FR')
    };
    
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(productData, null, 2));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", `produit_${productName.replace(/\s+/g, '_')}.json`);
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

function adjustStock() {
    const currentStock = document.querySelector('[th\\:text*="stock"]')?.textContent || '0';
    const adjustment = prompt(`Stock actuel: ${currentStock}\nEntrez l'ajustement (+ ou -):`, '0');
    
    if (adjustment !== null && !isNaN(adjustment)) {
        const reason = prompt('Raison de l\'ajustement:', '');
        if (reason !== null) {
            // Créer un formulaire pour soumettre l'ajustement
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = window.location.pathname + '/adjust-stock';
            
            const adjustmentInput = document.createElement('input');
            adjustmentInput.type = 'hidden';
            adjustmentInput.name = 'adjustment';
            adjustmentInput.value = adjustment;
            
            const reasonInput = document.createElement('input');
            reasonInput.type = 'hidden';
            reasonInput.name = 'reason';
            reasonInput.value = reason;
            
            form.appendChild(adjustmentInput);
            form.appendChild(reasonInput);
            document.body.appendChild(form);
            form.submit();
        }
    }
}

function deleteProduct() {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce produit ? Cette action est irréversible.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = window.location.pathname + '/delete';
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
</th:block>
</body>
</html>