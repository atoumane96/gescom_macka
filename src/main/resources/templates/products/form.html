<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::title}, ~{::content}, ~{::js_assets})}">
<head>
    <title th:text="${isEdit} ? 'Modifier le Produit' : 'Nouveau Produit'">Formulaire Produit</title>
</head>
<body>

<!-- JavaScript et Styles -->
<th:block th:fragment="js_assets">
    <!-- Styles CSS professionnels -->
    <style>
        /* Variables CSS pour la cohérence */
        :root {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-600: #475569;
            --gray-900: #0f172a;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --border-radius: 8px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        
        .page-container {
            background: #fff;
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .page-header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 24px 0;
            margin-bottom: 32px;
        }
        
        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0 0 8px 0;
        }
        
        .page-subtitle {
            color: var(--gray-600);
            font-size: 16px;
            margin: 0;
        }
        
        .form-container {
            max-width: none;
            padding: 0 24px;
        }
        
        .form-section {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .section-header {
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            padding: 16px 24px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 8px;
            color: var(--primary-color);
        }
        
        .section-body {
            padding: 24px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .form-row.two-cols {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .form-row.three-cols {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .form-row.four-cols {
            grid-template-columns: repeat(4, 1fr);
        }
        
        .form-group {
            position: relative;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 6px;
        }
        
        .form-label.required::after {
            content: " *";
            color: var(--danger-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
        }
        
        .form-control:invalid {
            border-color: var(--danger-color);
        }
        
        .form-control.is-invalid {
            border-color: var(--danger-color);
        }
        
        .invalid-feedback {
            display: block;
            color: var(--danger-color);
            font-size: 12px;
            margin-top: 4px;
        }
        
        .input-group {
            display: flex;
        }
        
        .input-group .form-control {
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }
        
        .input-group .btn {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            border-left: 0;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 500;
            border-radius: var(--border-radius);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border-color: var(--gray-300);
        }
        
        .btn-secondary:hover {
            background: var(--gray-200);
        }
        
        .btn-outline {
            background: white;
            color: var(--gray-700);
            border-color: var(--gray-300);
        }
        
        .btn-outline:hover {
            background: var(--gray-50);
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }
        
        .btn-icon {
            padding: 8px 12px;
        }
        
        .image-upload-section {
            border: 2px dashed var(--gray-300);
            border-radius: var(--border-radius);
            padding: 40px;
            text-align: center;
            background: var(--gray-50);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .image-upload-section:hover {
            border-color: var(--primary-color);
            background: rgb(59 130 246 / 0.02);
        }
        
        .image-upload-section.drag-over {
            border-color: var(--primary-color);
            background: rgb(59 130 246 / 0.05);
        }
        
        .image-upload-section.has-image {
            border-style: solid;
            background: white;
        }
        
        .upload-content h5 {
            color: var(--gray-900);
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .upload-content p {
            color: var(--gray-600);
            margin-bottom: 16px;
        }
        
        .image-preview {
            position: relative;
            display: inline-block;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
        }
        
        .image-overlay {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
        }
        
        .progress {
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
            margin: 16px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-success {
            background: rgb(16 185 129 / 0.1);
            color: var(--success-color);
        }
        
        .status-warning {
            background: rgb(245 158 11 / 0.1);
            color: var(--warning-color);
        }
        
        .status-danger {
            background: rgb(239 68 68 / 0.1);
            color: var(--danger-color);
        }
        
        .price-display {
            background: var(--primary-color);
            color: white;
            padding: 16px;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .price-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .form-check {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .form-check-input {
            margin-top: 2px;
        }
        
        .form-check-label {
            font-size: 14px;
            color: var(--gray-900);
        }
        
        .form-text {
            font-size: 12px;
            color: var(--gray-600);
            margin-top: 4px;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: var(--border-radius);
            border: 1px solid transparent;
            margin-bottom: 16px;
        }
        
        .alert-info {
            background: rgb(59 130 246 / 0.1);
            border-color: rgb(59 130 246 / 0.2);
            color: var(--primary-dark);
        }
        
        .alert-success {
            background: rgb(16 185 129 / 0.1);
            border-color: rgb(16 185 129 / 0.2);
            color: var(--success-color);
        }
        
        .alert-warning {
            background: rgb(245 158 11 / 0.1);
            border-color: rgb(245 158 11 / 0.2);
            color: var(--warning-color);
        }
        
        .alert-danger {
            background: rgb(239 68 68 / 0.1);
            border-color: rgb(239 68 68 / 0.2);
            color: var(--danger-color);
        }
        
        .actions-bar {
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 1px solid var(--gray-200);
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1);
        }
        
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 9999;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .form-row.two-cols,
            .form-row.three-cols,
            .form-row.four-cols {
                grid-template-columns: 1fr;
            }
            
            .form-container {
                padding: 0 16px;
            }
            
            .section-body {
                padding: 16px;
            }
            
            .actions-bar {
                flex-direction: column;
                gap: 12px;
            }
        }
        
        @media (max-width: 1200px) {
            .form-row.four-cols {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Styles pour les datalist */
        datalist {
            display: none;
        }
    </style>

    <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // Éléments du formulaire
        const form = document.getElementById('productForm');
        const stockInput = document.getElementById('stock');
        const minStockInput = document.getElementById('minStock');
        const maxStockInput = document.getElementById('maxStock');
        const unitPriceInput = document.getElementById('unitPrice');
        const purchasePriceInput = document.getElementById('purchasePrice');
        const vatRateSelect = document.getElementById('vatRate');
        const nameInput = document.getElementById('name');
        const categoryInput = document.getElementById('category');
        const referenceInput = document.getElementById('reference');
        const descriptionInput = document.getElementById('description');
        const generateRefBtn = document.getElementById('generateRefBtn');
        
        // Éléments pour les images
        const imageUploadArea = document.getElementById('imageUploadArea');
        const uploadZone = document.getElementById('uploadZone');
        const uploadContent = document.getElementById('uploadContent');
        const imageFile = document.getElementById('imageFile');
        const browseBtn = document.getElementById('browseBtn');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreviewImg = document.getElementById('imagePreviewImg');
        const changeImageBtn = document.getElementById('changeImageBtn');
        const removeImageBtn = document.getElementById('removeImageBtn');
        const imageUrlInput = document.getElementById('imageUrl');
        const loadUrlBtn = document.getElementById('loadUrlBtn');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        
        // Éléments d'affichage
        const stockStatus = document.getElementById('stockStatus');
        const priceDisplay = document.getElementById('priceDisplay');
        const priceValue = document.getElementById('priceValue');
        const descCharCount = document.getElementById('descCharCount');
        
        // Configuration
        const maxFileSize = 5 * 1024 * 1024; // 5MB
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];

        // Validation et mise à jour du stock
        function updateStockStatus() {
            if (!stockInput || !stockStatus) return;
            
            const stock = parseInt(stockInput.value) || 0;
            const minStock = parseInt(minStockInput?.value) || 0;
            
            let statusClass = 'status-success';
            let statusText = 'Stock correct';
            
            if (stock === 0) {
                statusClass = 'status-danger';
                statusText = 'Rupture';
            } else if (stock <= minStock) {
                statusClass = 'status-warning';
                statusText = 'Stock faible';
            }
            
            stockStatus.innerHTML = `<span class="status-badge ${statusClass}">${statusText}</span>`;
        }

        // Calcul et affichage du prix TTC
        function updatePriceDisplay() {
            if (!unitPriceInput || !priceDisplay || !priceValue) return;
            
            const unitPrice = parseFloat(unitPriceInput.value) || 0;
            const vatRate = parseFloat(vatRateSelect?.value) || 0;
            
            if (unitPrice > 0) {
                const priceIncludingVat = unitPrice * (1 + vatRate / 100);
                priceValue.textContent = priceIncludingVat.toFixed(2) + ' €';
                priceDisplay.style.display = 'block';
            } else {
                priceDisplay.style.display = 'none';
            }
        }

        // Génération automatique de référence
        function generateReference() {
            if (!nameInput || !categoryInput || !referenceInput) return;
            
            const name = nameInput.value.trim();
            const category = categoryInput.value.trim();
            
            if (name && category && !referenceInput.value) {
                const nameCode = name.substring(0, 3).toUpperCase().replace(/[^A-Z0-9]/g, '');
                const categoryCode = category.substring(0, 3).toUpperCase().replace(/[^A-Z0-9]/g, '');
                const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                referenceInput.value = `${categoryCode}-${nameCode}-${randomNum}`;
                
                showNotification('Référence générée automatiquement', 'success');
            }
        }

        // Compteur de caractères pour la description
        function updateCharCount() {
            if (!descriptionInput || !descCharCount) return;
            
            const length = descriptionInput.value.length;
            descCharCount.textContent = `${length}/1000 caractères`;
            
            if (length > 900) {
                descCharCount.style.color = 'var(--warning-color)';
            } else {
                descCharCount.style.color = 'var(--gray-600)';
            }
        }

        // Gestion des images
        function handleDragOver(e) {
            e.preventDefault();
            if (uploadZone) uploadZone.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            if (uploadZone) uploadZone.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            if (uploadZone) uploadZone.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        }

        function handleFileSelect(file) {
            // Validation
            if (!allowedTypes.includes(file.type)) {
                showNotification('Type de fichier non supporté. Utilisez JPG, PNG, WebP ou GIF.', 'danger');
                return;
            }
            
            if (file.size > maxFileSize) {
                showNotification('Le fichier est trop volumineux (max 5MB).', 'danger');
                return;
            }
            
            // Affichage de la progression
            showUploadProgress();
            
            // Lecture du fichier
            const reader = new FileReader();
            reader.onload = function(e) {
                setTimeout(() => {
                    hideUploadProgress();
                    showImagePreview(e.target.result);
                    if (imageUrlInput) imageUrlInput.value = '';
                    
                    const imageName = document.getElementById('imageName');
                    const imageSize = document.getElementById('imageSize');
                    if (imageName) imageName.textContent = file.name;
                    if (imageSize) imageSize.textContent = formatFileSize(file.size);
                    
                    showNotification('Image téléchargée avec succès !', 'success');
                }, 1500);
            };
            reader.readAsDataURL(file);
        }

        function showImagePreview(src) {
            if (!imagePreviewImg || !uploadContent || !imagePreviewContainer || !uploadZone) return;
            
            imagePreviewImg.src = src;
            uploadContent.style.display = 'none';
            imagePreviewContainer.style.display = 'block';
            uploadZone.classList.add('has-image');
        }

        function hideImagePreview() {
            if (!imagePreviewImg || !uploadContent || !imagePreviewContainer || !uploadZone) return;
            
            imagePreviewImg.src = '';
            uploadContent.style.display = 'block';
            imagePreviewContainer.style.display = 'none';
            uploadZone.classList.remove('has-image');
            
            const imageName = document.getElementById('imageName');
            const imageSize = document.getElementById('imageSize');
            if (imageName) imageName.textContent = '';
            if (imageSize) imageSize.textContent = '';
        }

        function showUploadProgress() {
            if (!uploadProgress || !progressBar) return;
            
            uploadProgress.style.display = 'block';
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 30;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                }
                progressBar.style.width = progress + '%';
            }, 100);
        }

        function hideUploadProgress() {
            if (!uploadProgress || !progressBar) return;
            
            uploadProgress.style.display = 'none';
            progressBar.style.width = '0%';
        }

        function loadImageFromUrl() {
            if (!imageUrlInput) return;
            
            const url = imageUrlInput.value.trim();
            if (!url) {
                showNotification('Veuillez entrer une URL valide.', 'warning');
                return;
            }
            
            showUploadProgress();
            
            const tempImg = new Image();
            tempImg.onload = function() {
                setTimeout(() => {
                    hideUploadProgress();
                    showImagePreview(url);
                    
                    const imageName = document.getElementById('imageName');
                    const imageSize = document.getElementById('imageSize');
                    if (imageName) imageName.textContent = url.split('/').pop() || 'Image depuis URL';
                    if (imageSize) imageSize.textContent = 'URL externe';
                    
                    showNotification('Image chargée depuis l\'URL !', 'success');
                }, 1000);
            };
            tempImg.onerror = function() {
                hideUploadProgress();
                showNotification('Impossible de charger l\'image depuis cette URL.', 'danger');
            };
            tempImg.src = url;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} notification`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn btn-sm" style="float: right; background: none; border: none; color: inherit;" onclick="this.parentElement.remove()">×</button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Event listeners avec vérifications
        if (stockInput) stockInput.addEventListener('input', updateStockStatus);
        if (minStockInput) minStockInput.addEventListener('input', updateStockStatus);
        if (unitPriceInput) unitPriceInput.addEventListener('input', updatePriceDisplay);
        if (vatRateSelect) vatRateSelect.addEventListener('change', updatePriceDisplay);
        if (descriptionInput) descriptionInput.addEventListener('input', updateCharCount);
        
        if (generateRefBtn) {
            generateRefBtn.addEventListener('click', (e) => {
                e.preventDefault();
                generateReference();
            });
        }
        
        // Gestion des images
        if (uploadZone) {
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            uploadZone.addEventListener('drop', handleDrop);
            uploadZone.addEventListener('click', (e) => {
                e.preventDefault();
                if (imageFile) imageFile.click();
            });
        }
        
        if (browseBtn) {
            browseBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (imageFile) imageFile.click();
            });
        }
        
        if (changeImageBtn) {
            changeImageBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (imageFile) imageFile.click();
            });
        }
        
        if (imageFile) {
            imageFile.addEventListener('change', (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }
        
        if (removeImageBtn) {
            removeImageBtn.addEventListener('click', (e) => {
                e.preventDefault();
                hideImagePreview();
                if (imageUrlInput) imageUrlInput.value = '';
                if (imageFile) imageFile.value = '';
                showNotification('Image supprimée.', 'info');
            });
        }
        
        if (loadUrlBtn) {
            loadUrlBtn.addEventListener('click', (e) => {
                e.preventDefault();
                loadImageFromUrl();
            });
        }

        // Validation du formulaire
        if (form) {
            form.addEventListener('submit', function(e) {
                let isValid = true;
                
                // Validation du prix
                const unitPrice = parseFloat(unitPriceInput?.value);
                if (unitPrice <= 0) {
                    showNotification('Le prix unitaire doit être supérieur à 0.', 'danger');
                    if (unitPriceInput) unitPriceInput.focus();
                    isValid = false;
                }
                
                // Validation du stock
                const stock = parseInt(stockInput?.value);
                if (stock < 0) {
                    showNotification('Le stock ne peut pas être négatif.', 'danger');
                    if (stockInput) stockInput.focus();
                    isValid = false;
                }
                
                if (!isValid) {
                    e.preventDefault();
                    return false;
                }
                
                showNotification('Sauvegarde en cours...', 'info');
            });
        }

        // Initialisation
        updateStockStatus();
        updatePriceDisplay();
        updateCharCount();
        
        // Charger l'image existante si présente
        if (imageUrlInput && imageUrlInput.value.trim()) {
            loadImageFromUrl();
        }
    });
    </script>
</th:block>

<div th:fragment="content">
    <div class="page-container">
        <!-- En-tête de page -->
        <div class="page-header">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title" th:text="${isEdit} ? 'Modifier le Produit' : 'Nouveau Produit'">Formulaire Produit</h1>
                        <p class="page-subtitle" th:text="${isEdit} ? 'Modification des informations produit' : 'Création d\'un nouveau produit'">Description</p>
                    </div>
                    <div class="d-flex gap-3">
                        <a th:href="@{/products}" class="btn btn-outline">
                            <i class="fas fa-arrow-left me-2"></i>Retour à la liste
                        </a>
                        <button type="submit" form="productForm" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            <span th:text="${isEdit} ? 'Modifier le Produit' : 'Créer le Produit'">Enregistrer</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulaire principal -->
        <div class="form-container">
            <div class="container-fluid">
                <form id="productForm" th:action="@{/products}" th:object="${product}" method="post" enctype="multipart/form-data" novalidate>
                    <input type="hidden" th:field="*{id}">
                    
                    <!-- Section: Informations Générales -->
                    <div class="form-section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-info-circle"></i>
                                Informations Générales
                            </h2>
                        </div>
                        <div class="section-body">
                            <div class="form-row two-cols">
                                <div class="form-group">
                                    <label for="name" class="form-label required">Nom du produit</label>
                                    <input type="text" class="form-control" id="name" th:field="*{name}"
                                           th:classappend="${#fields.hasErrors('name')} ? 'is-invalid'"
                                           placeholder="Ex: iPhone 14 Pro Max" required maxlength="100">
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}" th:errors="*{name}">
                                        Erreur nom
                                    </div>
                                    <div class="form-text">Le nom sera utilisé pour la recherche et l'affichage</div>
                                </div>

                                <div class="form-group">
                                    <label for="reference" class="form-label required">Référence</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="reference" th:field="*{reference}"
                                               th:classappend="${#fields.hasErrors('reference')} ? 'is-invalid'"
                                               placeholder="Ex: IPH-14P-001" required maxlength="50">
                                        <button type="button" class="btn btn-success btn-icon" id="generateRefBtn" title="Générer automatiquement">
                                            <i class="fas fa-magic"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('reference')}" th:errors="*{reference}">
                                        Erreur référence
                                    </div>
                                    <div class="form-text">Référence unique pour identifier le produit</div>
                                </div>
                            </div>

                            <div class="form-row two-cols">
                                <div class="form-group">
                                    <label for="category" class="form-label required">Catégorie</label>
                                    <input type="text" class="form-control" id="category" th:field="*{category}"
                                           th:classappend="${#fields.hasErrors('category')} ? 'is-invalid'"
                                           placeholder="Ex: Électronique, Textile..." required maxlength="50"
                                           list="categoryList">
                                    <datalist id="categoryList">
                                        <option value="Électronique">
                                        <option value="Textile">
                                        <option value="Maison & Jardin">
                                        <option value="Sport & Loisirs">
                                        <option value="Beauté & Santé">
                                        <option value="Automobile">
                                        <option value="Alimentation">
                                        <option value="Livres & Médias">
                                    </datalist>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('category')}" th:errors="*{category}">
                                        Erreur catégorie
                                    </div>
                                    <div class="form-text">Aide à organiser et filtrer les produits</div>
                                </div>

                                <div class="form-group">
                                    <label for="brand" class="form-label">Marque</label>
                                    <input type="text" class="form-control" id="brand" th:field="*{brand}"
                                           placeholder="Ex: Apple, Samsung..." maxlength="50" list="brandList">
                                    <datalist id="brandList">
                                        <option value="Apple">
                                        <option value="Samsung">
                                        <option value="Google">
                                        <option value="Microsoft">
                                        <option value="Nike">
                                        <option value="Adidas">
                                    </datalist>
                                    <div class="form-text">Marque du fabricant (optionnel)</div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label for="description" class="form-label">Description détaillée</label>
                                    <textarea class="form-control" id="description" th:field="*{description}" rows="4"
                                              placeholder="Décrivez les caractéristiques, fonctionnalités et avantages du produit..."
                                              maxlength="1000"></textarea>
                                    <div class="d-flex justify-content-between">
                                        <div class="form-text">Description qui apparaîtra aux clients (facultatif)</div>
                                        <small class="text-muted" id="descCharCount">0/1000 caractères</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section: Prix et Stock -->
                    <div class="form-section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-euro-sign"></i>
                                Prix et Stock
                            </h2>
                        </div>
                        <div class="section-body">
                            <div class="form-row three-cols">
                                <div class="form-group">
                                    <label for="unitPrice" class="form-label required">Prix unitaire (€)</label>
                                    <input type="number" class="form-control" id="unitPrice" th:field="*{unitPrice}"
                                           th:classappend="${#fields.hasErrors('unitPrice')} ? 'is-invalid'"
                                           step="0.01" min="0.01" placeholder="0.00" required>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('unitPrice')}" th:errors="*{unitPrice}">
                                        Erreur prix unitaire
                                    </div>
                                    <div class="price-display mt-2" id="priceDisplay" style="display: none;">
                                        <div class="price-value" id="priceValue">0.00 €</div>
                                        <small>Prix TTC</small>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="purchasePrice" class="form-label">Prix d'achat (€)</label>
                                    <input type="number" class="form-control" id="purchasePrice" th:field="*{purchasePrice}"
                                           step="0.01" min="0" placeholder="0.00">
                                    <div class="form-text">Prix de revient du produit</div>
                                </div>

                                <div class="form-group">
                                    <label for="vatRate" class="form-label">Taux TVA (%)</label>
                                    <select class="form-control" id="vatRate" th:field="*{vatRate}">
                                        <option value="0">0% (Exonéré)</option>
                                        <option value="5">5.5% (Réduit)</option>
                                        <option value="10">10% (Intermédiaire)</option>
                                        <option value="18" selected>18% (Normal)</option>
                                        <option value="20">20% (Normal UE)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row four-cols">
                                <div class="form-group">
                                    <label for="stock" class="form-label required">Stock actuel</label>
                                    <input type="number" class="form-control" id="stock" th:field="*{stock}"
                                           th:classappend="${#fields.hasErrors('stock')} ? 'is-invalid'"
                                           min="0" placeholder="0" required>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('stock')}" th:errors="*{stock}">
                                        Erreur stock
                                    </div>
                                    <div class="mt-2" id="stockStatus"></div>
                                </div>

                                <div class="form-group">
                                    <label for="minStock" class="form-label">Stock minimum</label>
                                    <input type="number" class="form-control" id="minStock" th:field="*{minStock}"
                                           min="0" placeholder="0">
                                    <div class="form-text">Seuil d'alerte stock bas</div>
                                </div>

                                <div class="form-group">
                                    <label for="maxStock" class="form-label">Stock maximum</label>
                                    <input type="number" class="form-control" id="maxStock" th:field="*{maxStock}"
                                           min="0" placeholder="1000">
                                    <div class="form-text">Limite de stockage</div>
                                </div>

                                <div class="form-group">
                                    <label for="unit" class="form-label">Unité</label>
                                    <select class="form-control" id="unit" th:field="*{unit}">
                                        <option value="pièce">Pièce</option>
                                        <option value="kg">Kilogramme</option>
                                        <option value="litre">Litre</option>
                                        <option value="mètre">Mètre</option>
                                        <option value="boîte">Boîte</option>
                                        <option value="pack">Pack</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section: Image -->
                    <div class="form-section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-image"></i>
                                Image du Produit
                            </h2>
                        </div>
                        <div class="section-body">
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <div class="image-upload-section" id="uploadZone">
                                        <div class="upload-content" id="uploadContent">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                            <h5>Cliquez ici ou glissez votre image</h5>
                                            <p>Pour ajouter une image du produit</p>
                                            <button type="button" class="btn btn-primary" id="browseBtn">
                                                <i class="fas fa-folder-open me-2"></i>Sélectionner un fichier
                                            </button>
                                            <div class="mt-3">
                                                <small class="text-muted">Formats acceptés: JPG, PNG, WebP, GIF (max 5MB)</small>
                                            </div>
                                        </div>

                                        <!-- Aperçu de l'image -->
                                        <div class="image-preview" id="imagePreviewContainer" style="display: none;">
                                            <img id="imagePreviewImg" src="" alt="Aperçu" class="preview-image">
                                            <div class="image-overlay">
                                                <button type="button" class="btn btn-secondary btn-icon" id="changeImageBtn">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline btn-icon" id="removeImageBtn">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            <div class="mt-3 text-center">
                                                <small class="text-muted">Nom: <span id="imageName"></span></small><br>
                                                <small class="text-muted">Taille: <span id="imageSize"></span></small>
                                            </div>
                                        </div>

                                        <!-- Barre de progression -->
                                        <div id="uploadProgress" style="display: none;">
                                            <div class="progress">
                                                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-muted">Téléchargement en cours...</small>
                                        </div>
                                    </div>

                                    <!-- Input file caché -->
                                    <input type="file" id="imageFile" name="imageFile" accept="image/*" style="display: none;">

                                    <!-- Alternative URL -->
                                    <div class="mt-4">
                                        <label for="imageUrl" class="form-label">Ou utilisez une URL d'image</label>
                                        <div class="input-group">
                                            <input type="url" class="form-control" id="imageUrl" th:field="*{imageUrl}"
                                                   placeholder="https://example.com/image.jpg" maxlength="200">
                                            <button type="button" class="btn btn-secondary" id="loadUrlBtn">
                                                <i class="fas fa-download"></i> Charger
                                            </button>
                                        </div>
                                        <div class="form-text">Collez l'URL d'une image disponible en ligne</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section: Caractéristiques -->
                    <div class="form-section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-cogs"></i>
                                Caractéristiques
                            </h2>
                        </div>
                        <div class="section-body">
                            <div class="form-row two-cols">
                                <div class="form-group">
                                    <label for="barCode" class="form-label">Code-barres</label>
                                    <input type="text" class="form-control" id="barCode" th:field="*{barCode}"
                                           placeholder="1234567890123" maxlength="50">
                                    <div class="form-text">Code-barres EAN ou autre standard</div>
                                </div>

                                <div class="form-group">
                                    <label for="weight" class="form-label">Poids (kg)</label>
                                    <input type="number" class="form-control" id="weight" th:field="*{weight}"
                                           step="0.001" min="0" placeholder="0.000">
                                    <div class="form-text">Poids unitaire du produit</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section: Gestion -->
                    <div class="form-section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-cog"></i>
                                Options de Gestion
                            </h2>
                        </div>
                        <div class="section-body">
                            <div class="form-row two-cols">
                                <div class="form-group">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="isActive" th:field="*{isActive}">
                                        <label class="form-check-label" for="isActive">
                                            <strong>Produit actif</strong><br>
                                            <small class="text-muted">Le produit est disponible à la vente</small>
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="isFeatured" th:field="*{isFeatured}">
                                        <label class="form-check-label" for="isFeatured">
                                            <strong>Produit mis en avant</strong><br>
                                            <small class="text-muted">Apparaît dans les suggestions et promotions</small>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label for="notes" class="form-label">Notes internes</label>
                                    <textarea class="form-control" id="notes" th:field="*{notes}" rows="3"
                                              placeholder="Notes et commentaires internes sur le produit..."></textarea>
                                    <div class="form-text">Ces notes ne sont visibles que par l'équipe interne</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section: Informations calculées (mode édition) -->
                    <div class="form-section" th:if="${isEdit}">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-calculator"></i>
                                Informations Calculées
                            </h2>
                        </div>
                        <div class="section-body">
                            <div class="form-row three-cols">
                                <div class="form-group">
                                    <label class="form-label">Prix TTC</label>
                                    <div class="price-display">
                                        <div class="price-value" th:text="${product.priceIncludingVat} + ' €'">0.00 €</div>
                                        <small>Prix toutes taxes comprises</small>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">État du stock</label>
                                    <div class="text-center py-3">
                                        <span class="status-badge status-success">En stock</span>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Marge bénéficiaire</label>
                                    <div class="text-center py-3">
                                        <div class="h4 text-success">À calculer</div>
                                        <small class="text-muted">Basé sur prix vente - prix achat</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Barre d'actions fixe -->
        <div class="actions-bar">
            <div class="d-flex align-items-center">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <span class="text-muted">Les champs marqués d'un astérisque (*) sont obligatoires</span>
            </div>
            <div class="d-flex gap-3">
                <a th:href="@{/products}" class="btn btn-secondary">
                    <i class="fas fa-times me-2"></i>Annuler
                </a>
                <button type="submit" form="productForm" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>
                    <span th:text="${isEdit} ? 'Modifier le Produit' : 'Créer le Produit'">Enregistrer les modifications</span>
                </button>
            </div>
        </div>
    </div>
</div>

</body>
</html>